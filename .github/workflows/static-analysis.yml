name: Static Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build SDK image (cached)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.ci
          tags: freeswitch-sdk:ci
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run analysis inside container
        uses: addnab/docker-run-action@v3
        with:
          image: freeswitch-sdk:ci
          options: -v ${{ github.workspace }}:/work
          run: |
            set -eux
            cd /work
            cmake -S . -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++ \
              -DCMAKE_C_COMPILER_LAUNCHER=ccache \
              -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

            scan-build --status-bugs cmake --build build -j"$(nproc)"

            clang-tidy -p build $(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx') \
              --warnings-as-errors='' || true

            cppcheck --enable=all --inconclusive --std=c++17 --force \
                     --project=build/compile_commands.json \
                     --suppress=missingIncludeSystem \
                     -i build . 2> cppcheck.log || true
